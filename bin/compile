#!/usr/bin/env bash

###########################
#       Compile           #
###########################

BP_DIR=$(
  cd $(dirname ${0:-})
  cd ..
  pwd
)

echo "Sourcing buildpack binaries"
PATH="$BP_DIR/lib:$PATH"

###########################
#       Release           #
###########################

# fail fast
set -ueo pipefail

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
HASURA_METADATA_DIR="$BUILD_DIR/hasura"

echo "Export necessary environment variables"
if [ -e "$ENV_DIR/HASURA_GRAPHQL_ENDPOINT" ]; then
  export HASURA_GRAPHQL_ENDPOINT="$(cat $ENV_DIR/HASURA_GRAPHQL_ENDPOINT)"
fi

if [ -e "$ENV_DIR/HASURA_GRAPHQL_ADMIN_SECRET" ]; then
  export HASURA_GRAPHQL_ADMIN_SECRET="$(cat $ENV_DIR/HASURA_GRAPHQL_ADMIN_SECRET)"
fi

echo "Update metadata"

cd $HASURA_METADATA_DIR
hasura metadata clear
hasura metadata apply
hasura metadata reload
